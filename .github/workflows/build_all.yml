name: Build all LaTeX projects

on:
  workflow_dispatch:

jobs:
  discover-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Discover LaTeX projects
        id: discover
        run: |
          echo "Searching for main.tex files..."
          projects=$(find . -mindepth 2 -maxdepth 2 -name main.tex -printf '%h\n')
          echo "Found projects:"
          echo "$projects"
          projects_json=$(echo "$projects" | jq -R -s -c 'split("\n")[:-1]')
          echo "projects=$projects_json" >> $GITHUB_OUTPUT

    outputs:
      projects: ${{ steps.discover.outputs.projects }}

  build:
    needs: discover-and-build
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-and-build.outputs.projects) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Compile LaTeX project
        uses: xu-cheng/latex-action@v4
        with:
          root_file: main.tex
          working_directory: ${{ matrix.project }}

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-pdf
          path: ${{ matrix.project }}/main.pdf

      - name: Send PDF to Discord
        if: ${{ env.DISCORD_WEBHOOK != '' }}
        env:
          DISCORD_WEBHOOK: ${{ env.DISCORD_WEBHOOK }}
          WORKDIR: ${{ matrix.project }}
          REPO_NAME: ${{ github.event.repository.name }}
          COMMIT_MESSAGE: ${{ steps.commit.outputs.message }}
          COMMIT_AUTHOR: ${{ steps.commit.outputs.author }}
        run: |
          CONTENT=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg dir "$WORKDIR" \
            --arg author "$COMMIT_AUTHOR" \
            --arg msg "$COMMIT_MESSAGE" \
            '{content: "# ðŸ“˜ **\($repo)** - (Building All)\n- Built **\($wdir)**\nðŸ§¾ Last Commit by **\($author)**:\n```\n\($msg)\n```"}')

          curl -F "payload_json=${CONTENT}" \
               -F "file=@${WORKDIR}/main.pdf" \
               "$DISCORD_WEBHOOK"